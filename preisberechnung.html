<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preisberechnung ‚Äì Holzarten</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body class="p-4 bg-light">
  <div class="container">
    <h1 class="mb-4 text-primary">Preisberechnung ‚Äì Holzarten</h1>

    <!-- Suche + Auswahl -->
    <div class="mb-3">
      <label class="form-label">Suche:</label>
      <input type="text" id="searchField" class="form-control w-50 d-inline-block" placeholder="Holzart suchen..."
        oninput="filterHolz()">
    </div>

    <div class="mb-3">
      <label class="me-2">Holzart:
        <select id="holzSelect" class="form-select d-inline-block w-auto"></select>
      </label>
      <label class="me-2">St√§rke (mm):
        <select id="staerkeSelect" class="form-select d-inline-block w-auto"></select>
      </label>
      <button class="btn btn-success me-2" onclick="holzHinzufuegen()">‚ûï Hinzuf√ºgen</button>
      <button class="btn btn-secondary" onclick="home()">üè† Heim</button>
    </div>

    <!-- Kundendaten -->
    <div class="mb-4 row g-3">
      <div class="col-md-6">
        <label class="form-label">Kunde Name:</label>
        <input type="text" id="kundeName" class="form-control" placeholder="Vor- und Nachname">
      </div>
      <div class="col-md-6">
        <label class="form-label">Telefon:</label>
        <input type="text" id="kundeTelefon" class="form-control" placeholder="Telefonnummer">
      </div>
    </div>

    <!-- Detailtabelle -->
    <h2 class="text-secondary">Detailtabelle</h2>
    <table id="input-tabelle" class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>Nr.</th>
          <th>Holzart</th>
          <th>St√§rke (mm)</th>
          <th>Art.-Nr.</th>
          <th>Preis/m¬≤</th>
          <th>L√§nge (cm)</th>
          <th>Breite (cm)</th>
          <th>St√ºck</th>
          <th>m¬≤</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="tabelle-body"></tbody>
    </table>

    <!-- Zusammenfassung -->
    <h2 class="text-secondary">Zwischensummen pro Holzart/St√§rke</h2>
    <table id="zusammenfassung-tabelle" class="table table-bordered align-middle">
      <thead class="table-success">
        <tr>
          <th>Holzart</th>
          <th>Art.-Nr.</th>
          <th>St√§rke (mm)</th>
          <th>Gesamtfl√§che (m¬≤)</th>
          <th>Preis (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody id="zusammenfassung-body"></tbody>
    </table>

    <!-- Buttons -->
    <div class="mb-3">
      <button class="btn btn-primary me-2" onclick="berechne()">‚úÖ Berechnen</button>
      <button class="btn btn-warning me-2" onclick="exportierePDF()">üìÑ Exportieren als PDF</button>
      <button class="btn btn-info" onclick="vorbereiteEmail()">‚úâÔ∏è E-Mail vorbereiten</button>
    </div>

    <!-- Ergebnis -->
    <h3 id="ergebnis" class="mt-3 text-dark"></h3>
    <!-- Haftungs- und Datenschutzhinweis -->
    <div class="alert alert-warning mt-3" id="hinweisText">
      <strong>Haftungsausschluss:</strong> Alle Angaben in dieser Berechnung dienen der Vorplanung. Endg√ºltige Pr√ºfung
      erfolgt durch autorisierte Mitarbeiter.<br>
      <strong>Datenschutz:</strong> Kundendaten werden ausschlie√ülich zur Bearbeitung der Bestellung verwendet.
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    let holzDaten = [];
    let aktuellGefilterteHolz = [];

    async function ladeHolzarten() {
      try {
        const response = await fetch('preise.json');
        holzDaten = await response.json();
        aktuellGefilterteHolz = [...holzDaten];
        updateHolzSelect();
      } catch (e) { console.error(e); }
    }

    function updateHolzSelect() {
      const select = document.getElementById('holzSelect');
      select.innerHTML = '';
      aktuellGefilterteHolz.forEach(h => {
        const option = document.createElement('option');
        option.value = h.holzname;
        option.textContent = h.holzname;
        select.appendChild(option);
      });
      updateStaerken();
    }

    function updateStaerken() {
      const holzname = document.getElementById('holzSelect').value;
      const staerkeSelect = document.getElementById('staerkeSelect');
      staerkeSelect.innerHTML = '';
      const holz = holzDaten.find(h => h.holzname === holzname);
      holz.st√§rken.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.mm;
        opt.textContent = `${s.mm} mm`;
        opt.dataset.preis = s.preisProM2;
        opt.dataset.artnr = s.ArtNr;
        staerkeSelect.appendChild(opt);
      });
    }

    document.getElementById('holzSelect').addEventListener('change', updateStaerken);

    function filterHolz() {
      const search = document.getElementById('searchField').value.toLowerCase();
      aktuellGefilterteHolz = holzDaten.filter(h => h.holzname.toLowerCase().includes(search));
      updateHolzSelect();
    }

    const tbody = document.getElementById('tabelle-body');

    function holzHinzufuegen() {
      const holzname = document.getElementById('holzSelect').value;
      const staerkeOpt = document.getElementById('staerkeSelect').selectedOptions[0];
      const staerke = staerkeOpt.value;
      const preis = parseFloat(staerkeOpt.dataset.preis);
      const artnr = staerkeOpt.dataset.artnr;

      const zeile = document.createElement('tr');

      // Holzart-Dropdown f√ºr die Zeile
      const holzSelectRow = document.createElement('select');
      holzDaten.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h.holzname;
        opt.textContent = h.holzname;
        if (h.holzname === holzname) opt.selected = true;
        holzSelectRow.appendChild(opt);
      });
      holzSelectRow.classList.add('form-select');

      // St√§rken-Dropdown f√ºr die Zeile
      const staerkeSelectRow = document.createElement('select');
      function updateStaerkeOptions(selectedHolz) {
        staerkeSelectRow.innerHTML = '';
        const holz = holzDaten.find(h => h.holzname === selectedHolz);
        holz.st√§rken.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.mm;
          opt.textContent = `${s.mm} mm`;
          opt.dataset.preis = s.preisProM2;
          opt.dataset.artnr = s.ArtNr;
          staerkeSelectRow.appendChild(opt);
        });
      }
      updateStaerkeOptions(holzname);
      staerkeSelectRow.value = staerke;
      staerkeSelectRow.classList.add('form-select');

      // Event: Wenn Holzart ge√§ndert wird
      holzSelectRow.addEventListener('change', function () {
        updateStaerkeOptions(this.value);
        staerkeSelectRow.selectedIndex = 0;
        const selectedOption = staerkeSelectRow.selectedOptions[0];
        zeile.cells[3].textContent = selectedOption.dataset.artnr;
        zeile.cells[4].textContent = parseFloat(selectedOption.dataset.preis).toFixed(2);
      });

      // Event: Wenn St√§rke ge√§ndert wird
      staerkeSelectRow.addEventListener('change', function () {
        const selectedOption = this.selectedOptions[0];
        zeile.cells[3].textContent = selectedOption.dataset.artnr;
        zeile.cells[4].textContent = parseFloat(selectedOption.dataset.preis).toFixed(2);
      });

      zeile.innerHTML = `
        <td class="zeilenNummer"></td>
        <td></td>
        <td></td>
        <td>${artnr}</td>
        <td>${preis.toFixed(2)}</td>
        <td><input type="number" class="form-control" min="0" onchange="updateM2(this)"></td>
        <td><input type="number" class="form-control" min="0" onchange="updateM2(this)"></td>
        <td><input type="number" class="form-control" min="1" value="1" onchange="updateM2(this)"></td>
        <td class="m2-zelle">0.00</td>
        <td><button class="btn btn-sm btn-danger" onclick="zeileLoeschen(this)">üóëÔ∏è</button></td>
      `;
      zeile.cells[1].appendChild(holzSelectRow);
      zeile.cells[2].appendChild(staerkeSelectRow);

      tbody.appendChild(zeile);
      nummernAktualisieren();
    }

    function zeileLoeschen(button) {
      button.closest('tr').remove();
      nummernAktualisieren();
    }

    function nummernAktualisieren() {
      document.querySelectorAll('.zeilenNummer').forEach((zelle, i) => zelle.textContent = i + 1);
    }

    function updateM2(elem) {
      const row = elem.closest('tr');
      const inputs = row.querySelectorAll('input');
      const [laenge, breite, stueck] = Array.from(inputs).map(i => parseFloat(i.value) || 0);
      row.querySelector('.m2-zelle').textContent = ((laenge / 100) * (breite / 100) * stueck).toFixed(2);
    }

    function berechne() {
      let gesamtM2 = 0, gesamtPreis = 0;
      const summary = {};

      document.querySelectorAll('#tabelle-body tr').forEach(row => {
        const m2 = parseFloat(row.querySelector('.m2-zelle').textContent) || 0;
        const preis = parseFloat(row.cells[4].textContent);
        const holz = row.cells[1].querySelector('select').value;
        const artnr = row.cells[3].textContent;
        const staerke = row.cells[2].querySelector('select').value;

        gesamtM2 += m2;
        gesamtPreis += m2 * preis;

        const key = `${holz}_${staerke}`;
        if (!summary[key]) summary[key] = { holz, artnr, staerke, m2: 0, preis: 0 };
        summary[key].m2 += m2;
        summary[key].preis += m2 * preis;
      });

      const tbodySum = document.getElementById('zusammenfassung-body');
      tbodySum.innerHTML = '';
      Object.values(summary).forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.holz}</td><td>${s.artnr}</td><td>${s.staerke}</td><td>${s.m2.toFixed(2)}</td><td>${s.preis.toFixed(2)}</td>`;
        tbodySum.appendChild(tr);
      });

      document.getElementById('ergebnis').textContent =
        `Gesamtfl√§che: ${gesamtM2.toFixed(2)} m¬≤ | Gesamtpreis: ${gesamtPreis.toFixed(2)} ‚Ç¨`;
    }

    function exportierePDF() {
      const doc = new jsPDF();
      const kunde = document.getElementById('kundeName').value || '-';
      const telefon = document.getElementById('kundeTelefon').value || '-';
      const bestellId = 'ID-' + Math.floor(Math.random() * 1000000);

      doc.setFontSize(16);
      doc.text('Holzzuschnitt Bestellung', 105, 15, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`Bestellungs-ID: ${bestellId}`, 10, 30);
      doc.text(`Kunde: ${kunde}`, 10, 37);
      doc.text(`Telefon: ${telefon}`, 10, 44);

      let startY = 55;
      const detailRows = [];
      document.querySelectorAll('#tabelle-body tr').forEach(row => {
        const cells = [];
        const holz = row.cells[1].querySelector('select').value;
        const staerke = row.cells[2].querySelector('select').value;
        cells.push(row.cells[0].textContent);
        cells.push(holz);
        cells.push(staerke);
        cells.push(row.cells[3].textContent);
        cells.push(row.cells[4].textContent);
        const inputs = row.querySelectorAll('input');
        cells.push(inputs[0].value);
        cells.push(inputs[1].value);
        cells.push(inputs[2].value);
        cells.push(row.querySelector('.m2-zelle').textContent);
        detailRows.push(cells);
      });

      doc.autoTable({
        head: [['Nr', 'Holzart', 'St√§rke', 'Art.-Nr.', 'Preis/m¬≤', 'L√§nge', 'Breite', 'St√ºck', 'm¬≤']],
        body: detailRows,
        startY: startY,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 10 },
        margin: { left: 10, right: 10 }
      });

      const summaryRows = [];
      document.querySelectorAll('#zusammenfassung-body tr').forEach(row => {
        const cells = Array.from(row.cells).map(c => c.textContent);
        summaryRows.push(cells);
      });

      doc.autoTable({
        head: [['Holzart', 'Art.-Nr.', 'St√§rke', 'Gesamtfl√§che', 'Preis']],
        body: summaryRows,
        startY: doc.lastAutoTable.finalY + 15,
        theme: 'grid',
        headStyles: { fillColor: [46, 204, 113], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 10 },
        margin: { left: 10, right: 10 }
      });

      // Haftungs- und Datenschutzhinweis
      const hinweisText = `Haftungsausschluss: Alle Angaben in dieser Berechnung dienen der Vorplanung. 
      \nEndg√ºltige Pr√ºfung erfolgt durch autorisierte Mitarbeiter.
      \nDatenschutz: Kundendaten werden ausschlie√ülich zur Bearbeitung der Bestellung verwendet.`;


      // Schriftart, Gr√∂√üe, Farbe festlegen
      doc.setFontSize(10);
      doc.setTextColor(200, 0, 0);
      doc.setFont(undefined, 'bold'); // optional: fett

      // Automatischer Zeilenumbruch nach Seitenrand
      const pageWidth = doc.internal.pageSize.width;
      const margin = 10;
      const textWidth = pageWidth - 2 * margin;

      // Text einf√ºgen unter der letzten Tabelle
      doc.text(doc.splitTextToSize(hinweisText, textWidth), margin, doc.lastAutoTable.finalY + 10);


      doc.save(`Bestellung_${bestellId}.pdf`);
    }

    function vorbereiteEmail() {
      const kunde = document.getElementById('kundeName').value || '-';
      const telefon = document.getElementById('kundeTelefon').value || '-';
      const bestellId = 'ID-' + Math.floor(Math.random() * 1000000);

      let emailText = `Holzzuschnitt Bestellung\nBestellungs-ID: ${bestellId}\nKunde: ${kunde}\nTelefon: ${telefon}\n\n--- Detailtabelle ---\n`;

      document.querySelectorAll('#tabelle-body tr').forEach(row => {
        const inputs = row.querySelectorAll('input');
        const holz = row.cells[1].querySelector('select').value;
        const staerke = row.cells[2].querySelector('select').value;
        emailText += `Nr: ${row.cells[0].textContent} | Holz: ${holz} | St√§rke: ${staerke} | ArtNr: ${row.cells[3].textContent} | Preis/m¬≤: ${row.cells[4].textContent} | L√§nge: ${inputs[0].value} | Breite: ${inputs[1].value} | St√ºck: ${inputs[2].value} | m¬≤: ${row.querySelector('.m2-zelle').textContent}\n`;
      });

      emailText += `\n--- Zwischensummen ---\n`;
      document.querySelectorAll('#zusammenfassung-body tr').forEach(row => {
        const cells = Array.from(row.cells).map(c => c.textContent);
        emailText += `Holz: ${cells[0]} | ArtNr: ${cells[1]} | St√§rke: ${cells[2]} | Gesamtfl√§che: ${cells[3]} | Preis: ${cells[4]}\n`;
      });

      emailText += `\nHinweis: Alle Angaben m√ºssen noch durch Mitarbeiter gepr√ºft werden.\n`;

      const mailtoLink = `mailto:?subject=Holzzuschnitt Bestellung ${bestellId}&body=${encodeURIComponent(emailText)}`;
      window.location.href = mailtoLink;
    }

    function home() { window.location.href = 'index.html'; }
    ladeHolzarten();
  </script>
</body>

</html>
