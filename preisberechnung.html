<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preisberechnung ‚Äì mehrere Holzarten</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; }
table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
input[type="number"], input[type="text"] { width: 80px; }
button { margin: 5px; padding: 8px 12px; }
select { padding: 6px; }
.loeschen-button { background-color: #e74c3c; color: white; border: none; cursor: pointer; padding: 4px 8px; }
.loeschen-button:hover { background-color: #c0392b; }
#searchField { margin-bottom: 10px; padding: 6px; width: 200px; }
</style>
</head>
<body>
<h1>Preisberechnung ‚Äì Holzarten</h1>

<div>
  <label>Suche: <input type="text" id="searchField" placeholder="Holzart suchen..." oninput="filterHolz()"></label>
  <br><br>
  <label>Holzart:
    <select id="holzSelect"></select>
  </label>
  <label>St√§rke (mm):
    <select id="staerkeSelect"></select>
  </label>
  <button onclick="holzHinzufuegen()">‚ûï Hinzuf√ºgen</button>
  <button class="home-button" onclick="home()">üè† Heim</button>
</div>

<div style="margin-bottom: 15px;">
  <label style="margin-right: 20px;">Kunde Name: 
    <input type="text" id="kundeName" style="width: 300px; padding: 6px;">
  </label>
  <label>Telefon: 
    <input type="text" id="kundeTelefon" style="width: 200px; padding: 6px;">
  </label>
</div>

<h2>Detailtabelle</h2>
<table id="input-tabelle">
<thead>
<tr>
<th>Nr.</th>
<th>Holzart</th>
<th>St√§rke (mm)</th>
<th>Art.-Nr.</th>
<th>Preis/m¬≤</th>
<th>L√§nge (cm)</th>
<th>Breite (cm)</th>
<th>St√ºck</th>
<th>m¬≤</th>
<th>Aktion</th>
</tr>
</thead>
<tbody id="tabelle-body"></tbody>
</table>

<h2>Zwischensummen pro Holzart/St√§rke</h2>
<table id="zusammenfassung-tabelle">
<thead>
<tr>
<th>Holzart</th>
<th>Art.-Nr.</th>
<th>St√§rke (mm)</th>
<th>Gesamtfl√§che (m¬≤)</th>
<th>Preis (‚Ç¨)</th>
</tr>
</thead>
<tbody id="zusammenfassung-body"></tbody>
</table>

<button onclick="berechne()">‚úÖ Berechnen</button>
<button onclick="exportierePDF()">üìÑ Exportieren als PDF</button>
<button onclick="vorbereiteEmail()">‚úâÔ∏è E-Mail vorbereiten</button>

<h3 id="ergebnis"></h3>

<script>
const { jsPDF } = window.jspdf;
let holzDaten = [];
let aktuellGefilterteHolz = [];

async function ladeHolzarten() {
  try {
    const response = await fetch('preise.json');
    holzDaten = await response.json();
    aktuellGefilterteHolz = [...holzDaten];
    updateHolzSelect();
  } catch(e) { console.error(e); }
}

function updateHolzSelect() {
  const select = document.getElementById('holzSelect');
  select.innerHTML = '';
  aktuellGefilterteHolz.forEach(h => {
    const option = document.createElement('option');
    option.value = h.holzname;
    option.textContent = h.holzname;
    select.appendChild(option);
  });
  updateStaerken();
}

function updateStaerken() {
  const holzname = document.getElementById('holzSelect').value;
  const staerkeSelect = document.getElementById('staerkeSelect');
  staerkeSelect.innerHTML = '';
  const holz = holzDaten.find(h => h.holzname === holzname);
  holz.st√§rken.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.mm;
    opt.textContent = `${s.mm} mm`;
    opt.dataset.preis = s.preisProM2;
    opt.dataset.artnr = s.ArtNr;
    staerkeSelect.appendChild(opt);
  });
}

document.getElementById('holzSelect').addEventListener('change', updateStaerken);

function filterHolz() {
  const search = document.getElementById('searchField').value.toLowerCase();
  aktuellGefilterteHolz = holzDaten.filter(h => h.holzname.toLowerCase().includes(search));
  updateHolzSelect();
}

const tbody = document.getElementById('tabelle-body');

function holzHinzufuegen() {
  const holzname = document.getElementById('holzSelect').value;
  const staerkeOpt = document.getElementById('staerkeSelect').selectedOptions[0];
  const staerke = staerkeOpt.value;
  const preis = parseFloat(staerkeOpt.dataset.preis);
  const artnr = staerkeOpt.dataset.artnr;

  const zeile = document.createElement('tr');
  zeile.innerHTML = `
    <td class="zeilenNummer"></td>
    <td>${holzname}</td>
    <td>${staerke}</td>
    <td>${artnr}</td>
    <td>${preis.toFixed(2)}</td>
    <td><input type="number" min="0" onchange="updateM2(this)"></td>
    <td><input type="number" min="0" onchange="updateM2(this)"></td>
    <td><input type="number" min="1" value="1" onchange="updateM2(this)"></td>
    <td class="m2-zelle">0.00</td>
    <td><button class="loeschen-button" onclick="zeileLoeschen(this)">üóëÔ∏è</button></td>
  `;
  tbody.appendChild(zeile);
  nummernAktualisieren();
}

function zeileLoeschen(button) {
  button.closest('tr').remove();
  nummernAktualisieren();
}

function nummernAktualisieren() {
  document.querySelectorAll('.zeilenNummer').forEach((zelle, i) => zelle.textContent = i+1);
}

function updateM2(elem) {
  const row = elem.closest('tr');
  const inputs = row.querySelectorAll('input');
  const [laenge, breite, stueck] = Array.from(inputs).map(i => parseFloat(i.value)||0);
  row.querySelector('.m2-zelle').textContent = ((laenge/100)*(breite/100)*stueck).toFixed(2);
}

function berechne() {
  let gesamtM2 = 0, gesamtPreis = 0;
  const summary = {};

  document.querySelectorAll('#tabelle-body tr').forEach(row => {
    const m2 = parseFloat(row.querySelector('.m2-zelle').textContent)||0;
    const preis = parseFloat(row.cells[4].textContent);
    const holz = row.cells[1].textContent;
    const artnr = row.cells[3].textContent;
    const staerke = row.cells[2].textContent;

    gesamtM2 += m2;
    gesamtPreis += m2*preis;

    const key = `${holz}_${staerke}`;
    if (!summary[key]) summary[key] = {holz, artnr, staerke, m2: 0, preis: 0};
    summary[key].m2 += m2;
    summary[key].preis += m2*preis;
  });

  const tbodySum = document.getElementById('zusammenfassung-body');
  tbodySum.innerHTML = '';
  Object.values(summary).forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.holz}</td><td>${s.artnr}</td><td>${s.staerke}</td><td>${s.m2.toFixed(2)}</td><td>${s.preis.toFixed(2)}</td>`;
    tbodySum.appendChild(tr);
  });

  document.getElementById('ergebnis').textContent =
    `Gesamtfl√§che: ${gesamtM2.toFixed(2)} m¬≤ | Gesamtpreis: ${gesamtPreis.toFixed(2)} ‚Ç¨`;
}

function exportierePDF() {
  const doc = new jsPDF();
  const kunde = document.getElementById('kundeName').value || '-';
  const telefon = document.getElementById('kundeTelefon').value || '-';
  const bestellId = 'ID-' + Math.floor(Math.random() * 1000000);

  doc.setFontSize(16);
  doc.text('Holzzuschnitt Bestellung', 105, 15, { align: 'center' });
  doc.setFontSize(12);
  doc.text(`Bestellungs-ID: ${bestellId}`, 10, 30);
  doc.text(`Kunde: ${kunde}`, 10, 37);
  doc.text(`Telefon: ${telefon}`, 10, 44);

  let startY = 55;
  const detailRows = [];
  document.querySelectorAll('#tabelle-body tr').forEach(row => {
    const cells = [];
    cells.push(row.cells[0].textContent);
    cells.push(row.cells[1].textContent);
    cells.push(row.cells[2].textContent);
    cells.push(row.cells[3].textContent);
    cells.push(row.cells[4].textContent);
    const inputs = row.querySelectorAll('input');
    cells.push(inputs[0].value);
    cells.push(inputs[1].value);
    cells.push(inputs[2].value);
    cells.push(row.querySelector('.m2-zelle').textContent);
    detailRows.push(cells);
  });

  doc.autoTable({
    head: [['Nr', 'Holzart', 'St√§rke', 'Art.-Nr.', 'Preis/m¬≤', 'L√§nge', 'Breite', 'St√ºck', 'm¬≤']],
    body: detailRows,
    startY: startY,
    theme: 'grid',
    headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' },
    styles: { fontSize: 10 },
    margin: { left: 10, right: 10 }
  });

  const summaryRows = [];
  document.querySelectorAll('#zusammenfassung-body tr').forEach(row => {
    const cells = Array.from(row.cells).map(c => c.textContent);
    summaryRows.push(cells);
  });

  doc.autoTable({
    head: [['Holzart', 'Art.-Nr.', 'St√§rke', 'Gesamtfl√§che', 'Preis']],
    body: summaryRows,
    startY: doc.lastAutoTable.finalY + 15,
    theme: 'grid',
    headStyles: { fillColor: [46, 204, 113], textColor: 255, fontStyle: 'bold' },
    styles: { fontSize: 10 },
    margin: { left: 10, right: 10 }
  });

  // Hinweis f√ºr Mitarbeiterpr√ºfung
  doc.setFontSize(10);
  doc.setTextColor(200,0,0);
  doc.text('Hinweis: Alle Angaben m√ºssen noch durch Mitarbeiter gepr√ºft werden.', 10, doc.lastAutoTable.finalY + 15);

  doc.save(`Bestellung_${bestellId}.pdf`);
}

// Neue Funktion f√ºr E-Mail-Vorbereitung
function vorbereiteEmail() {
  const kunde = document.getElementById('kundeName').value || '-';
  const telefon = document.getElementById('kundeTelefon').value || '-';
  const bestellId = 'ID-' + Math.floor(Math.random() * 1000000);

  let emailText = `Holzzuschnitt Bestellung\nBestellungs-ID: ${bestellId}\nKunde: ${kunde}\nTelefon: ${telefon}\n\n--- Detailtabelle ---\n`;

  document.querySelectorAll('#tabelle-body tr').forEach(row => {
    const inputs = row.querySelectorAll('input');
    emailText += `Nr: ${row.cells[0].textContent} | Holz: ${row.cells[1].textContent} | St√§rke: ${row.cells[2].textContent} | ArtNr: ${row.cells[3].textContent} | Preis/m¬≤: ${row.cells[4].textContent} | L√§nge: ${inputs[0].value} | Breite: ${inputs[1].value} | St√ºck: ${inputs[2].value} | m¬≤: ${row.querySelector('.m2-zelle').textContent}\n`;
  });

  emailText += `\n--- Zwischensummen ---\n`;
  document.querySelectorAll('#zusammenfassung-body tr').forEach(row => {
    emailText += `Holz: ${row.cells[0].textContent} | ArtNr: ${row.cells[1].textContent} | St√§rke: ${row.cells[2].textContent} | Gesamtfl√§che: ${row.cells[3].textContent} | Preis: ${row.cells[4].textContent}\n`;
  });

  emailText += `\nHinweis: Alle Angaben m√ºssen noch durch Mitarbeiter gepr√ºft werden.\n`;

  const mailtoLink = `mailto:?subject=Holzzuschnitt Bestellung ${bestellId}&body=${encodeURIComponent(emailText)}`;
  window.location.href = mailtoLink;
}
function home() { window.location.href = 'index.html'; }
ladeHolzarten();
</script>
</body>
</html>
